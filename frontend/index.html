<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>WARFORT+</title>
<style>
    body { margin:0; background:#111; overflow:hidden; }
    canvas { background:#222; display:block; margin:0 auto; }

    #ui {
        position:fixed;
        top:10px;
        left:10px;
        color:white;
        font-family:sans-serif;
        background:rgba(0,0,0,0.55);
        padding:10px;
        border-radius:6px;
        border:1px solid #0af;
        box-shadow:0 0 12px #0af;
    }
    #minimap {
        position:fixed;
        right:10px;
        bottom:10px;
        width:170px;
        height:170px;
        background:#000;
        border:3px solid #08f;
        border-radius:50%;
        box-shadow:0 0 20px #08f;
    }
    #weapons {
        position:fixed;
        bottom:15px;
        left:50%;
        transform:translateX(-50%);
        display:flex;
        gap:10px;
    }
    .weaponSlot {
        width:60px;
        height:60px;
        border:2px solid #aaa;
        border-radius:8px;
        background:#0008;
        display:flex;
        align-items:center;
        justify-content:center;
        color:white;
        font-size:14px;
        box-shadow:0 0 10px #000;
        transition:0.15s;
    }
    .weaponSlot.active {
        border-color:#0f0;
        box-shadow:0 0 12px #0f0;
        transform:scale(1.1);
    }
</style>
</head>

<body>
<div id="ui">
    <div>
        <label>Nombre:</label>
        <input id="nameInput" placeholder="Tu nombre">
        <button onclick="startGame()">Entrar</button>
    </div>
    <div id="stats" style="display:none;">
        <p>Vida: <span id="hp">100</span></p>
        <p>Stamina: <span id="staminaText">100</span></p>
        <p>Madera: <span id="wood">0</span></p>
        <p>Piedra: <span id="stone">0</span></p>
        <p>Comida: <span id="food">0</span></p>
        <p>Oro: <span id="gold">0</span></p>
        <p>Zoom: <span id="zoomValue">1</span>x</p>
    </div>
</div>

<div id="weapons">
    <div class="weaponSlot active" id="weapon1">üî™</div>
    <div class="weaponSlot" id="weapon2">üèπ</div>
    <div class="weaponSlot" id="weapon3">üõ°Ô∏è</div>
</div>

<canvas id="game" width="900" height="600"></canvas>
<canvas id="minimap"></canvas>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
/* =========================
        CONFIG
========================= */
const SERVER_URL = "https://warfort.onrender.com";
let socket = null;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const minimap = document.getElementById("minimap");
const mctx = minimap.getContext("2d");

let username = "";
let zoom = 1;
let time = 0;

/* =========================
       JUGADOR
========================= */
let player = {
    x: 400,
    y: 300,
    dx: 0,
    dy: 0,
    speed: 3,
    hp: 100,
    stamina: 100,
    dir: 1,
    weapon: 1
};

let particles = [];
let arrows = [];

let otherPlayers = {};
let map = { trees:[], bushes:[], stones:[], animals:[], wheels:[], forts:[] };
let keys = {};

let camera = { x:0, y:0, lerpX:0, lerpY:0, width:900, height:600 };
const WORLD = { width:3000, height:3000 };

/* =========================
        INICIAR
========================= */
function startGame() {
    const name = document.getElementById("nameInput").value.trim();
    if (!name) return;

    username = name;
    document.getElementById("stats").style.display = "block";

    socket = io(SERVER_URL);

    socket.on("connect", () => {
        socket.emit("join", { name: username, x: player.x, y: player.y });
    });

    socket.on("init", data => {
        map = data.map;
        otherPlayers = data.players;
    });

    socket.on("state", data => {
        if (data.players) {
            for (let id in data.players) {
                if (data.players[id] === null) delete otherPlayers[id];
                else otherPlayers[id] = data.players[id];
            }
        }
        if (data.map) map = data.map;
    });

    loop();
}

/* =========================
       CONTROLES
========================= */
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup",   e => keys[e.key] = false);

canvas.addEventListener("wheel", e => {
    zoom -= e.deltaY * 0.001;
    zoom = Math.max(0.6, Math.min(2.5, zoom));
    document.getElementById("zoomValue").innerText = zoom.toFixed(2);
});

/* CAMBIO DE ARMA */
document.addEventListener("keydown", e => {
    if (e.key >= "1" && e.key <= "3") {
        player.weapon = parseInt(e.key);
        updateWeaponUI();
    }
});

/* DISPARAR ARCO */
canvas.addEventListener("click", e => {
    if (player.weapon === 2) shootArrow(e);
});

function updateWeaponUI() {
    document.querySelectorAll(".weaponSlot").forEach(s => s.classList.remove("active"));
    document.getElementById("weapon" + player.weapon).classList.add("active");
}

/* =========================
      ARROW SYSTEM
========================= */
function shootArrow(e) {
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) / zoom + camera.lerpX;
    const my = (e.clientY - rect.top) / zoom + camera.lerpY;

    const ang = Math.atan2(my - player.y, mx - player.x);

    arrows.push({
        x: player.x,
        y: player.y,
        vx: Math.cos(ang) * 10,
        vy: Math.sin(ang) * 10,
        life: 90
    });
}

/* =========================
       UPDATE PLAYER
========================= */
function updatePlayer() {
    player.dx = 0;
    player.dy = 0;

    let speed = player.speed;

    if (keys["Shift"] && player.stamina > 0) {
        speed = 5;
        player.stamina -= 0.8;
        spawnParticles();
    } else {
        player.stamina += 0.4;
    }

    player.stamina = Math.max(0, Math.min(100, player.stamina));
    document.getElementById("staminaText").innerText = player.stamina.toFixed(0);

    if (keys["w"]) player.dy = -speed;
    if (keys["s"]) player.dy = speed;
    if (keys["a"]) player.dx = -speed, player.dir = -1;
    if (keys["d"]) player.dx = speed, player.dir = 1;

    player.x += player.dx;
    player.y += player.dy;

    player.x = Math.max(0, Math.min(WORLD.width, player.x));
    player.y = Math.max(0, Math.min(WORLD.height, player.y));

    if (socket) socket.emit("update", { x: player.x, y: player.y });
}

/* =========================
     PARTICULAS
========================= */
function spawnParticles() {
    particles.push({
        x: player.x,
        y: player.y + 10,
        size: 4,
        alpha: 1,
        vx: (Math.random() - 0.5) * 1,
        vy: 1 + Math.random()
    });
}

function updateParticles() {
    particles = particles.filter(p => p.alpha > 0.05);
    for (let p of particles) {
        p.x += p.vx;
        p.y += p.vy;
        p.alpha -= 0.03;
    }
}

/* =========================
       UPDATE ARROWS
========================= */
function updateArrows() {
    arrows = arrows.filter(a => a.life > 0);
    for (let a of arrows) {
        a.x += a.vx;
        a.y += a.vy;
        a.life--;
    }
}

/* =========================
        DIBUJO
========================= */
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    time += 0.002;
    let night = (Math.sin(time) + 1) / 2;

    camera.lerpX += (player.x - camera.lerpX - camera.width/2/zoom) * 0.1;
    camera.lerpY += (player.y - camera.lerpY - camera.height/2/zoom) * 0.1;

    ctx.save();
    ctx.scale(zoom, zoom);
    ctx.translate(-camera.lerpX, -camera.lerpY);

    drawGrid();
    drawParticles();
    drawArrows();
    drawPlayer();
    drawOtherPlayers();
    drawDarkness(night);

    ctx.restore();

    drawMinimap();
}

/* GRID */
function drawGrid() {
    ctx.strokeStyle = "rgba(255,255,255,0.04)";
    for (let i = 0; i < WORLD.width; i += 50) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, WORLD.height);
        ctx.stroke();
    }
    for (let j = 0; j < WORLD.height; j += 50) {
        ctx.beginPath();
        ctx.moveTo(0, j);
        ctx.lineTo(WORLD.width, j);
        ctx.stroke();
    }
}

/* ARROWS */
function drawArrows() {
    ctx.fillStyle = "orange";
    arrows.forEach(a => {
        ctx.fillRect(a.x, a.y, 8, 3);
    });
}

/* PLAYER */
function drawPlayer() {
    ctx.fillStyle = "cyan";
    ctx.beginPath();
    ctx.arc(player.x, player.y, 10, 0, Math.PI*2);
    ctx.fill();

    ctx.strokeStyle = "#fff";
    ctx.beginPath();
    ctx.moveTo(player.x, player.y);
    ctx.lineTo(player.x + player.dir * 20, player.y);
    ctx.stroke();

    ctx.fillStyle = "white";
    ctx.font = "14px Arial";
    ctx.fillText(username, player.x - 20, player.y - 18);

    ctx.fillStyle = "red";
    ctx.fillRect(player.x - 15, player.y - 25, 30, 4);
    ctx.fillStyle = "lime";
    ctx.fillRect(player.x - 15, player.y - 25, player.hp * 0.3, 4);
}

/* OTHER PLAYERS */
function drawOtherPlayers() {
    for (let id in otherPlayers) {
        const p = otherPlayers[id];

        ctx.fillStyle = "#ff0";
        ctx.beginPath();
        ctx.arc(p.x, p.y, 10, 0, Math.PI*2);
        ctx.fill();

        ctx.fillStyle = "#fff";
        ctx.fillText(p.name ?? "Player", p.x - 20, p.y - 15);
    }
}

/* DARKNESS */
function drawDarkness(intensity) {
    ctx.fillStyle = `rgba(0,0,30,${intensity * 0.7})`;
    ctx.fillRect(camera.lerpX, camera.lerpY, WORLD.width, WORLD.height);

    let grad = ctx.createRadialGradient(player.x, player.y, 10, player.x, player.y, 220);
    grad.addColorStop(0, "rgba(255,255,255,0)");
    grad.addColorStop(1, `rgba(0,0,0,${0.7 * intensity})`);

    ctx.fillStyle = grad;
    ctx.fillRect(camera.lerpX, camera.lerpY, WORLD.width, WORLD.height);
}

/* MINIMAP */
function drawMinimap() {
    mctx.fillStyle = "#000";
    mctx.fillRect(0,0,minimap.width,minimap.height);

    let sx = minimap.width / WORLD.width;
    let sy = minimap.height / WORLD.height;

    mctx.fillStyle = "cyan";
    mctx.beginPath();
    mctx.arc(player.x * sx, player.y * sy, 4, 0, Math.PI*2);
    mctx.fill();

    mctx.fillStyle = "yellow";
    for (let id in otherPlayers) {
        let p = otherPlayers[id];
        mctx.beginPath();
        mctx.arc(p.x * sx, p.y * sy, 3, 0, Math.PI*2);
        mctx.fill();
    }
}

/* LOOP */
function loop() {
    updatePlayer();
    updateParticles();
    updateArrows();
    draw();
    requestAnimationFrame(loop);
}
</script>

</body>
</html>
